# 新建外设插件

## 1、新建子项目

第一步要在Plugins项目下新建子项目，项目类型为C++library

### 1.1 子项目命名规范

项目命名统一遵循plugin_yyy_xxx，yyy表示设备类型代码，具体定义见下表。xxx表示厂商及型号缩写，以南天二代证为例，命名为plugin_idr_nt,子项目类名可遵循YyyXxx，如IdrNt。

| 序号 | 设备类型         | 设备代码 |
| ---- | ---------------- | -------- |
| 1    | 二代证           | idr      |
| 2    | IC卡             | ic       |
| 3    | 指纹仪           | fp       |
| 4    | 磁条卡           | msf      |
| 5    | 密码键盘及柜外清 | pin      |
| 6    | etc读卡器        | etc      |

### 1.2 子项目生成

子项目生成后会生成以下文件，以IdrNt为例

![image-20210421002504448](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210421002504448.png)

#### 1.2.1 plugin_idr_nt_global.h

主要定义了PLUGIN_IDR_NT_EXPORT，使用者可以不用再处理符号的导入和导出细节

``` c++
#ifndef PLUGIN_IDR_NT_GLOBAL_H
#define PLUGIN_IDR_NT_GLOBAL_H

#include <QtCore/qglobal.h>

#if defined(PLUGIN_IDR_NT_LIBRARY)
#  define PLUGIN_IDR_NT_EXPORT Q_DECL_EXPORT
#else
#  define PLUGIN_IDR_NT_EXPORT Q_DECL_IMPORT
#endif

#endif // PLUGIN_IDR_NT_GLOBAL_H

```

#### 1.2.2 IdrNt.h

此类要继承IDevicePlugin类，所以要包含对应头文件，具体格式如下

```c++
#include "../../DHContracts/IDevicePlugin.h"
class PLUGIN_IDR_NT_EXPORT IdrNt : public IDevicePlugin
{
	...
    IDeviceResponse* Process(IDeviceRequest* request);
    void ApplyConfiguration(QMap<QString,QVariant> configs);
};
```

插件类可以重写IDevicePlugin类的process方法和ApplyConfiguration，ApplyConfiguration执行时可以进行一些自定义的设置。并且要用extern “C”生成导出符号，方便主程序使用。

``` c++
extern "C" PLUGIN_IDR_NT_EXPORT IDevicePlugin* CreatePlugin()
{
    return new IdrNt();
}

```

#### 1.2.3 IdrNt.cpp

插件类的实现文件，实现process具体内容

``` c++
IDeviceResponse* IdrSt::Process(IDeviceRequest* request)
{
    IDeviceResponse* response = new DeviceResponse();
    response->SetResult("idr调用成功");
    response->SetRetCode(0);
    response->SetRetMsg("");
    return response;
}

```

### 1.3 插件配置文件

将插件配置文件放置到对应的插件目录下，以供程序调用

#### 1.3.1 配置文件存放路径及添加

DeviceHost\Plugins目录下相应的插件文件夹，如南天二代证配置文件放在DeviceHost\Plugins\plugin_idr_nt目录下，在插件子目录下右键选择添加现有文件，添加json配置文件，就可以在工程内看到添加的json文件

![image-20210420234618738](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210420234618738.png)

#### 1.3.2 配置文件命名规则及格式

配置文件格式为json格式，文件命名规则为yyy_xxx,yyy表示设备类型代码，具体定义参见下表。xxx表示厂商及型号缩写,以南天二代证为例，文件名称为idr_nt.json。

| 序号 | 设备类型         | 设备代码 |
| ---- | ---------------- | -------- |
| 1    | 二代证           | idr      |
| 2    | IC卡             | ic       |
| 3    | 指纹仪           | fp       |
| 4    | 磁条卡           | msf      |
| 5    | 密码键盘及柜外清 | pin      |
| 6    | etc读卡器        | etc      |

json文件内容具体格式及各项内容如下

```json
{
    "lib":"Plugins/plugin_idr_nt",
    "type":"idr",
    "name":"南天二代证",
    "configs":{
        "xxx":"111"
    }
}
```

| key     | 内容                             |
| ------- | -------------------------------- |
| lib     | 插件路径                         |
| type    | 表示设备类型                     |
| name    | 表示具体设备名称                 |
| configs | 配置厂商驱动的路径等个性化的设置 |

## 2、pro文件修改

### 2.1 添加包含库

在插件项目处右键选择添加库，库类型选择内部库，添加调用插件所需的DHContracts、DHCore库，添加完成pro文件会出现以下代码,以DHContracts库为例

```makefile
win32:CONFIG(release, debug|release): LIBS += -L$$OUT_PWD/../../DHContracts/release/ -lDHContracts
else:win32:CONFIG(debug, debug|release): LIBS += -L$$OUT_PWD/../../DHContracts/debug/ -lDHContracts
else:unix: LIBS += -L$$OUT_PWD/../../DHContracts/ -lDHContracts
```

由于内部库的生成路径不同，所以要根据内部库位置对路径进行修改，在DHContracts.pro文件有

```makefile
DESTDIR = ../bin
```

所以根据实际情况将代码修改如下，插件位于DeviceHost\Plugins\plugin_idr_nt所以此处包含两组../ ，对pro文件路径的修改、添加都要根据实际情况修改

```makefile
win32:CONFIG(release, debug|release): LIBS += -L$$OUT_PWD/../../bin/ -lDHContracts
else:win32:CONFIG(debug, debug|release): LIBS += -L$$OUT_PWD/../../bin/ -lDHContracts
else:unix: LIBS += -L$$OUT_PWD/../../bin/ -lDHContracts

win32:CONFIG(release, debug|release): LIBS += -L$$OUT_PWD/../../bin/ -lDHCore
else:win32:CONFIG(debug, debug|release): LIBS += -L$$OUT_PWD/../../bin/ -lDHCore
else:unix: LIBS += -L$$OUT_PWD/../../bin/ -lDHCore
```

### 2.2 动态库生成目录

在pro文件中添加 **DESTDIR = ../../bin/Plugins** ，指定动态库生成目录

### 2.3  指定存放目录

指定应放置所有中间对象的目录。指定应放置所有中间Moc文件的目录。

```makefile
unix:MOC_DIR = ./tmp
win32:MOC_DIR = tmp

unix:OBJECTS_DIR = ./tmp
win32:OBJECTS_DIR = tmp
```

### 2.4 添加INCLUDEPATH、DEPENDPATH

指定编译项目时应搜索的#include目录。指定供qmake扫描以解决依赖关系的目录列表。在pro文件添加以下代码

```makefile
INCLUDEPATH += $$PWD/../../bin
DEPENDPATH += $$PWD/../../bin
```

### 2.5 拷贝附加文件

可实现将上文新建的配置文件拷贝到Configs/ConfigDev目录中，需在pro文件中添加以下代码

``` makefile
# 配置file_copies,将配置文件copy到/../../bin/Configs/ConfigDev目录下
CONFIG += file_copies

json.files = $$PWD/idr_nt.json
json.path = $$OUT_PWD/../../bin/Configs/ConfigDev/
COPIES += json
```



